{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}    
    <h1>Process execution</h1>
    {% include '_progress_div.html' %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="//cdnjs.cloudflare.com/ajax/libs/nanobar/0.2.1/nanobar.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
 
    {% if use_redis == 'True' %}
        <script src="static/js/progress_handler.js"></script>
        <script>
            $(function() {
                $('#start-bg-job').click(start_long_task);
            });
        </script>
    {% else %}
        <script>
            function execute_task() {
                var source = new EventSource("/execute_task");
                source.onmessage = function(event) {
                    var data = JSON.parse(event.data);
                    if ('current' in data) {
                        percent = parseInt(data.current * 100 / data.total);
                        pb = document.getElementById("progress-bar").style.width = percent + "%";
                        document.getElementById("progress-label").innerHTML = percent + '% - ' + data['current'] + '/' + data['total'];
                    }
                    if ('header' in data) {
                        $('#progress-header').text(data.header);
                    }
                    if ('close' in data) {
                        source.close()
                    }
                }
            }
            $(function() {
                $('#start-bg-job').click(execute_task);
            });
        </script>
    {% endif %}        
{% endblock %}
